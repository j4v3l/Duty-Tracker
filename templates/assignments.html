{% extends "base.html" %} {% block title %}Assignments - Duty Tracker{% endblock
%} {% block head %}
<script>
  // Pass server data to Alpine.js
  window.serverData = {
    stats: {{ stats | tojson | safe }},
    assignments: {{ assignments | tojson | safe }}
  };
</script>
{% endblock %} {% block content %}
<div x-data="assignmentsPageData()" x-init="init()">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-clipboard-list mr-2"></i>
          Assignment Management
        </h1>
        <p class="text-gray-600">View and manage all duty assignments</p>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white p-4 rounded-lg shadow flex items-center space-x-6">
        <div class="text-center">
          <div
            class="text-2xl font-bold text-green-600"
            x-text="stats.active_assignments || 0"
          ></div>
          <div class="text-sm text-gray-500">Active</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-blue-600"
            x-text="totalAssignments"
          ></div>
          <div class="text-sm text-gray-500">Total</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-yellow-600"
            x-text="todaysAssignments"
          ></div>
          <div class="text-sm text-gray-500">Today</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mb-6 flex flex-wrap gap-4">
    <button
      @click="openNewAssignmentModal()"
      class="military-primary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
    >
      <i class="fas fa-plus mr-2"></i>
      New Assignment
    </button>

    <button
      @click="refreshData()"
      class="military-secondary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
    >
      <i class="fas fa-sync mr-2"></i>
      Refresh
    </button>

    <!-- Filter Controls -->
    <div class="flex gap-2 ml-auto">
      <select
        x-model="statusFilter"
        @change="filterAssignments()"
        class="px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="all">All Status</option>
        <option value="assigned">Assigned</option>
        <option value="completed">Completed</option>
        <option value="no-show">No Show</option>
      </select>

      <input
        type="date"
        x-model="dateFilter"
        @change="filterAssignments()"
        class="px-3 py-2 border border-gray-300 rounded-lg"
      />

      <input
        type="text"
        x-model="searchQuery"
        @input="filterAssignments()"
        placeholder="Search assignments..."
        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
      />
    </div>
  </div>

  <!-- Assignments Table -->
  <div class="bg-white shadow overflow-hidden sm:rounded-md">
    <div class="px-4 py-5 sm:px-6">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            Assignment Records
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            <span x-text="filteredAssignments.length"></span>
            <span
              x-text="filteredAssignments.length === 1 ? 'assignment' : 'assignments'"
            ></span>
            found
          </p>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="responsive-table min-w-full" x-show="!loading">
        <thead>
          <tr>
            <th>Personnel</th>
            <th>Post</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Difficulty</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template
            x-for="assignment in paginatedAssignments"
            :key="assignment.id"
          >
            <tr class="fade-in hover:bg-gray-50">
              <td>
                <div class="flex items-center">
                  <span
                    class="rank-badge mr-2"
                    x-text="assignment.person.rank"
                  ></span>
                  <div>
                    <div
                      class="font-medium text-gray-900"
                      x-text="assignment.person.name"
                    ></div>
                    <div
                      class="text-sm text-gray-500"
                      x-text="'ID: ' + assignment.person.id"
                    ></div>
                  </div>
                </div>
              </td>
              <td>
                <div>
                  <div class="font-medium" x-text="assignment.post.name"></div>
                  <div
                    class="text-sm text-gray-500"
                    x-text="assignment.post.post_type.name"
                  ></div>
                </div>
              </td>
              <td>
                <div
                  class="text-sm"
                  x-text="formatDate(assignment.duty_date)"
                ></div>
              </td>
              <td>
                <div class="text-sm">
                  <span x-text="assignment.start_time || 'N/A'"></span>
                  <span x-show="assignment.end_time"> - </span>
                  <span x-text="assignment.end_time || ''"></span>
                </div>
              </td>
              <td>
                <span
                  :class="getStatusClass(assignment.status)"
                  x-text="assignment.status"
                ></span>
              </td>
              <td>
                <div class="text-center">
                  <span
                    class="text-sm font-medium"
                    x-text="assignment.post.post_type.difficulty_weight"
                  ></span>
                  <div class="text-xs text-gray-500">points</div>
                </div>
              </td>
              <td>
                <div class="flex space-x-2">
                  <button
                    @click="editAssignment(assignment)"
                    class="text-blue-600 hover:text-blue-800 text-sm"
                  >
                    <i class="fas fa-edit mr-1"></i>
                    Edit
                  </button>
                  <button
                    @click="deleteAssignment(assignment.id)"
                    class="text-red-600 hover:text-red-800 text-sm"
                  >
                    <i class="fas fa-trash mr-1"></i>
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- Pagination -->
      <div
        x-show="totalPages > 1"
        class="px-4 py-3 border-t border-gray-200 bg-gray-50"
      >
        <div class="flex justify-between items-center">
          <div class="text-sm text-gray-700">
            Showing <span x-text="startRecord"></span> to
            <span x-text="endRecord"></span> of
            <span x-text="filteredAssignments.length"></span> results
          </div>
          <div class="flex space-x-1">
            <button
              @click="currentPage = Math.max(1, currentPage - 1)"
              :disabled="currentPage === 1"
              :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
              class="px-3 py-1 text-sm border rounded transition-colors"
            >
              Previous
            </button>

            <template x-for="page in visiblePages" :key="page">
              <button
                @click="currentPage = page"
                :class="page === currentPage ? 'bg-blue-500 text-white' : 'hover:bg-gray-200'"
                class="px-3 py-1 text-sm border rounded transition-colors"
                x-text="page"
              ></button>
            </template>

            <button
              @click="currentPage = Math.min(totalPages, currentPage + 1)"
              :disabled="currentPage === totalPages"
              :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
              class="px-3 py-1 text-sm border rounded transition-colors"
            >
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div
        x-show="!loading && filteredAssignments.length === 0"
        class="p-8 text-center text-gray-500"
      >
        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
        <p class="text-lg font-medium">No assignments found</p>
        <p class="text-sm">Try adjusting your search or filters</p>
      </div>

      <div x-show="loading" class="p-8 text-center">
        <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
        <p class="mt-2 text-gray-500">Loading assignments...</p>
      </div>
    </div>
  </div>

  <!-- Assignment Statistics -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-chart-line text-3xl text-green-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Completion Rate</h3>
          <p
            class="text-2xl font-bold text-green-600"
            x-text="completionRate + '%'"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-clock text-3xl text-blue-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">This Week</h3>
          <p
            class="text-2xl font-bold text-blue-600"
            x-text="thisWeekCount"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i
          class="fas fa-exclamation-triangle text-3xl text-yellow-500 mr-4"
        ></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">No Shows</h3>
          <p
            class="text-2xl font-bold text-yellow-600"
            x-text="noShowCount"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-weight-hanging text-3xl text-purple-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Avg Difficulty</h3>
          <p
            class="text-2xl font-bold text-purple-600"
            x-text="averageDifficulty"
          ></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function assignmentsPageData() {
    return {
      loading: false,
      assignments: [],
      filteredAssignments: [],
      stats: {},
      statusFilter: "all",
      dateFilter: "",
      searchQuery: "",
      currentPage: 1,
      itemsPerPage: 25,

      init() {
        this.stats = window.serverData.stats || {};
        this.assignments = window.serverData.assignments || [];
        this.filterAssignments();
      },

      filterAssignments() {
        let filtered = this.assignments;

        // Apply status filter
        if (this.statusFilter !== "all") {
          filtered = filtered.filter(
            (assignment) => assignment.status === this.statusFilter
          );
        }

        // Apply date filter
        if (this.dateFilter) {
          filtered = filtered.filter(
            (assignment) =>
              assignment.duty_date &&
              assignment.duty_date.startsWith(this.dateFilter)
          );
        }

        // Apply search filter
        if (this.searchQuery.trim()) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(
            (assignment) =>
              assignment.person.name.toLowerCase().includes(query) ||
              assignment.person.rank.toLowerCase().includes(query) ||
              assignment.post.name.toLowerCase().includes(query) ||
              assignment.post.post_type.name.toLowerCase().includes(query)
          );
        }

        this.filteredAssignments = filtered;
        this.currentPage = 1; // Reset to first page when filtering
      },

      refreshData() {
        window.location.reload();
      },

      openNewAssignmentModal() {
        // Redirect to main dashboard with modal
        window.location.href = "/#new-assignment";
      },

      editAssignment(assignment) {
        console.log("Edit assignment:", assignment);
      },

      deleteAssignment(assignmentId) {
        if (confirm("Are you sure you want to delete this assignment?")) {
          console.log("Delete assignment:", assignmentId);
        }
      },

      formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString();
      },

      getStatusClass(status) {
        switch (status) {
          case "assigned":
            return "status-assigned";
          case "completed":
            return "status-completed";
          case "no-show":
            return "status-no-show";
          default:
            return "status-assigned";
        }
      },

      get totalAssignments() {
        return this.assignments.length;
      },

      get todaysAssignments() {
        const today = new Date().toISOString().split("T")[0];
        return this.assignments.filter(
          (a) => a.duty_date && a.duty_date.startsWith(today)
        ).length;
      },

      get completionRate() {
        if (this.assignments.length === 0) return 0;
        const completed = this.assignments.filter(
          (a) => a.status === "completed"
        ).length;
        return Math.round((completed / this.assignments.length) * 100);
      },

      get thisWeekCount() {
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        return this.assignments.filter((a) => {
          const assignmentDate = new Date(a.duty_date);
          return assignmentDate >= weekAgo && assignmentDate <= today;
        }).length;
      },

      get noShowCount() {
        return this.assignments.filter((a) => a.status === "no-show").length;
      },

      get averageDifficulty() {
        if (this.assignments.length === 0) return 0;
        const total = this.assignments.reduce(
          (sum, a) => sum + (a.post.post_type.difficulty_weight || 1),
          0
        );
        return (total / this.assignments.length).toFixed(1);
      },

      get totalPages() {
        return Math.ceil(this.filteredAssignments.length / this.itemsPerPage);
      },

      get paginatedAssignments() {
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        return this.filteredAssignments.slice(start, end);
      },

      get startRecord() {
        return (this.currentPage - 1) * this.itemsPerPage + 1;
      },

      get endRecord() {
        return Math.min(
          this.currentPage * this.itemsPerPage,
          this.filteredAssignments.length
        );
      },

      get visiblePages() {
        const pages = [];
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(this.totalPages, this.currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
          pages.push(i);
        }

        return pages;
      },
    };
  }
</script>
{% endblock %}
