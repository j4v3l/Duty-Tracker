{% extends "base.html" %} {% block title %}Assignments - Duty Tracker{% endblock
%} {% block head %}
<script>
  // Pass server data to Alpine.js
  window.serverData = {
    stats: {{ stats | tojson | safe }},
    assignments: {{ assignments | tojson | safe }}
  };
</script>
{% endblock %} {% block content %}
<div x-data="assignmentsPageData()" x-init="init()">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-clipboard-list mr-2"></i>
          Assignment Management
        </h1>
        <p class="text-gray-600">View and manage all duty assignments</p>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white p-4 rounded-lg shadow flex items-center space-x-6">
        <div class="text-center">
          <div
            class="text-2xl font-bold text-green-600"
            x-text="stats.active_assignments || 0"
          ></div>
          <div class="text-sm text-gray-500">Active</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-blue-600"
            x-text="totalAssignments"
          ></div>
          <div class="text-sm text-gray-500">Total</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-yellow-600"
            x-text="todaysAssignments"
          ></div>
          <div class="text-sm text-gray-500">Today</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mb-6 flex flex-wrap gap-4">
    <button
      @click="openNewAssignmentModal()"
      class="military-primary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
    >
      <i class="fas fa-plus mr-2"></i>
      New Assignment
    </button>

    <button
      @click="refreshData()"
      class="military-secondary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
    >
      <i class="fas fa-sync mr-2"></i>
      Refresh
    </button>

    <!-- Filter Controls -->
    <div class="flex gap-2 ml-auto">
      <select
        x-model="statusFilter"
        @change="filterAssignments()"
        class="px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="all">All Status</option>
        <option value="assigned">Assigned</option>
        <option value="completed">Completed</option>
        <option value="no-show">No Show</option>
      </select>

      <input
        type="date"
        x-model="dateFilter"
        @change="filterAssignments()"
        class="px-3 py-2 border border-gray-300 rounded-lg"
      />

      <input
        type="text"
        x-model="searchQuery"
        @input="filterAssignments()"
        placeholder="Search assignments..."
        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
      />
    </div>
  </div>

  <!-- Assignments Table -->
  <div class="bg-white shadow overflow-hidden sm:rounded-md">
    <div class="px-4 py-5 sm:px-6">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            Assignment Records
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            <span x-text="filteredAssignments.length"></span>
            <span
              x-text="filteredAssignments.length === 1 ? 'assignment' : 'assignments'"
            ></span>
            found
          </p>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="responsive-table min-w-full" x-show="!loading">
        <thead>
          <tr>
            <th>Personnel</th>
            <th>Post</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Difficulty</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template
            x-for="assignment in paginatedAssignments"
            :key="assignment.id"
          >
            <tr class="fade-in hover:bg-gray-50">
              <td>
                <div class="flex items-center">
                  <span
                    class="rank-badge mr-2"
                    x-text="assignment.person.rank"
                  ></span>
                  <div>
                    <div
                      class="font-medium text-gray-900"
                      x-text="assignment.person.name"
                    ></div>
                    <div
                      class="text-sm text-gray-500"
                      x-text="'ID: ' + assignment.person.id"
                    ></div>
                  </div>
                </div>
              </td>
              <td>
                <div>
                  <div class="font-medium" x-text="assignment.post.name"></div>
                  <div
                    class="text-sm text-gray-500"
                    x-text="assignment.post.post_type.name"
                  ></div>
                </div>
              </td>
              <td>
                <div
                  class="text-sm"
                  x-text="formatDate(assignment.duty_date)"
                ></div>
              </td>
              <td>
                <div class="text-sm">
                  <span x-text="assignment.start_time || 'N/A'"></span>
                  <span x-show="assignment.end_time"> - </span>
                  <span x-text="assignment.end_time || ''"></span>
                </div>
              </td>
              <td>
                <span
                  :class="getStatusClass(assignment.status)"
                  x-text="assignment.status"
                ></span>
              </td>
              <td>
                <div class="text-center">
                  <span
                    class="text-sm font-medium"
                    x-text="assignment.post.post_type.difficulty_weight"
                  ></span>
                  <div class="text-xs text-gray-500">points</div>
                </div>
              </td>
              <td>
                <div class="flex space-x-2">
                  <button
                    @click="editAssignment(assignment)"
                    class="text-blue-600 hover:text-blue-800 text-sm"
                  >
                    <i class="fas fa-edit mr-1"></i>
                    Edit
                  </button>
                  <button
                    @click="deleteAssignment(assignment.id)"
                    class="text-red-600 hover:text-red-800 text-sm"
                  >
                    <i class="fas fa-trash mr-1"></i>
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- Pagination -->
      <div
        x-show="totalPages > 1"
        class="px-4 py-3 border-t border-gray-200 bg-gray-50"
      >
        <div class="flex justify-between items-center">
          <div class="text-sm text-gray-700">
            Showing <span x-text="startRecord"></span> to
            <span x-text="endRecord"></span> of
            <span x-text="filteredAssignments.length"></span> results
          </div>
          <div class="flex space-x-1">
            <button
              @click="currentPage = Math.max(1, currentPage - 1)"
              :disabled="currentPage === 1"
              :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
              class="px-3 py-1 text-sm border rounded transition-colors"
            >
              Previous
            </button>

            <template x-for="page in visiblePages" :key="page">
              <button
                @click="currentPage = page"
                :class="page === currentPage ? 'bg-blue-500 text-white' : 'hover:bg-gray-200'"
                class="px-3 py-1 text-sm border rounded transition-colors"
                x-text="page"
              ></button>
            </template>

            <button
              @click="currentPage = Math.min(totalPages, currentPage + 1)"
              :disabled="currentPage === totalPages"
              :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
              class="px-3 py-1 text-sm border rounded transition-colors"
            >
              Next
            </button>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div
        x-show="!loading && filteredAssignments.length === 0"
        class="p-8 text-center text-gray-500"
      >
        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
        <p class="text-lg font-medium">No assignments found</p>
        <p class="text-sm">Try adjusting your search or filters</p>
      </div>

      <div x-show="loading" class="p-8 text-center">
        <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
        <p class="mt-2 text-gray-500">Loading assignments...</p>
      </div>
    </div>
  </div>

  <!-- Assignment Statistics -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-chart-line text-3xl text-green-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Completion Rate</h3>
          <p
            class="text-2xl font-bold text-green-600"
            x-text="completionRate + '%'"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-clock text-3xl text-blue-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">This Week</h3>
          <p
            class="text-2xl font-bold text-blue-600"
            x-text="thisWeekCount"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i
          class="fas fa-exclamation-triangle text-3xl text-yellow-500 mr-4"
        ></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">No Shows</h3>
          <p
            class="text-2xl font-bold text-yellow-600"
            x-text="noShowCount"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-weight-hanging text-3xl text-purple-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Avg Difficulty</h3>
          <p
            class="text-2xl font-bold text-purple-600"
            x-text="averageDifficulty"
          ></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function assignmentsPageData() {
    return {
      loading: false,
      assignments: [],
      filteredAssignments: [],
      stats: {},
      statusFilter: "all",
      dateFilter: "",
      searchQuery: "",
      currentPage: 1,
      itemsPerPage: 25,
      showNewAssignmentModal: false,
      showEditAssignmentModal: false,
      editingAssignment: null,
      newAssignment: {
        person_id: "",
        post_id: "",
        duty_date: "",
        start_time: "",
        end_time: "",
        notes: "",
      },
      personnel: [],
      posts: [],

      async init() {
        this.stats = window.serverData.stats || {};
        this.assignments = window.serverData.assignments || [];
        this.filterAssignments();

        // Load additional data for modal
        await this.loadPersonnelAndPosts();
      },

      async loadPersonnelAndPosts() {
        try {
          const [personnelResponse, postsResponse] = await Promise.all([
            fetch("/api/personnel"),
            fetch("/api/posts"),
          ]);

          this.personnel = personnelResponse.ok
            ? await personnelResponse.json()
            : [];
          this.posts = postsResponse.ok ? await postsResponse.json() : [];
        } catch (error) {
          console.error("Failed to load personnel and posts:", error);
          this.personnel = [];
          this.posts = [];
        }
      },

      filterAssignments() {
        let filtered = this.assignments;

        // Apply status filter
        if (this.statusFilter !== "all") {
          filtered = filtered.filter(
            (assignment) => assignment.status === this.statusFilter
          );
        }

        // Apply date filter
        if (this.dateFilter) {
          filtered = filtered.filter(
            (assignment) =>
              assignment.duty_date &&
              assignment.duty_date.startsWith(this.dateFilter)
          );
        }

        // Apply search filter
        if (this.searchQuery.trim()) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(
            (assignment) =>
              assignment.person.name.toLowerCase().includes(query) ||
              assignment.person.rank.toLowerCase().includes(query) ||
              assignment.post.name.toLowerCase().includes(query) ||
              assignment.post.post_type.name.toLowerCase().includes(query)
          );
        }

        this.filteredAssignments = filtered;
        this.currentPage = 1; // Reset to first page when filtering
      },

      refreshData() {
        window.location.reload();
      },

      openNewAssignmentModal() {
        this.newAssignment = {
          person_id: "",
          post_id: "",
          duty_date: this.dateFilter || new Date().toISOString().split("T")[0],
          start_time: "",
          end_time: "",
          notes: "",
        };
        this.showNewAssignmentModal = true;
      },

      refreshData() {
        window.location.reload();
      },

      async createNewAssignment() {
        try {
          const response = await fetch("/api/assignments", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...this.newAssignment,
              duty_date: new Date(this.newAssignment.duty_date).toISOString(),
            }),
          });

          if (response.ok) {
            this.refreshData();
            this.showNewAssignmentModal = false;
          } else {
            const error = await response.json();
            alert("Failed to create assignment: " + error.detail);
          }
        } catch (error) {
          alert("Failed to create assignment: " + error.message);
        }
      },

      editAssignment(assignment) {
        this.editingAssignment = { ...assignment };
        this.showEditAssignmentModal = true;
      },

      async updateAssignment() {
        try {
          const response = await fetch(
            `/api/assignments/${this.editingAssignment.id}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(this.editingAssignment),
            }
          );

          if (response.ok) {
            this.refreshData();
            this.showEditAssignmentModal = false;
            this.editingAssignment = null;
          } else {
            const error = await response.json();
            alert("Failed to update assignment: " + error.detail);
          }
        } catch (error) {
          alert("Failed to update assignment: " + error.message);
        }
      },

      deleteAssignment(assignmentId) {
        if (confirm("Are you sure you want to delete this assignment?")) {
          console.log("Delete assignment:", assignmentId);
        }
      },

      formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString();
      },

      getStatusClass(status) {
        switch (status) {
          case "assigned":
            return "status-assigned";
          case "completed":
            return "status-completed";
          case "no-show":
            return "status-no-show";
          default:
            return "status-assigned";
        }
      },

      get totalAssignments() {
        return this.assignments.length;
      },

      get todaysAssignments() {
        const today = new Date().toISOString().split("T")[0];
        return this.assignments.filter(
          (a) => a.duty_date && a.duty_date.startsWith(today)
        ).length;
      },

      get completionRate() {
        if (this.assignments.length === 0) return 0;
        const completed = this.assignments.filter(
          (a) => a.status === "completed"
        ).length;
        return Math.round((completed / this.assignments.length) * 100);
      },

      get thisWeekCount() {
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        return this.assignments.filter((a) => {
          const assignmentDate = new Date(a.duty_date);
          return assignmentDate >= weekAgo && assignmentDate <= today;
        }).length;
      },

      get noShowCount() {
        return this.assignments.filter((a) => a.status === "no-show").length;
      },

      get averageDifficulty() {
        if (this.assignments.length === 0) return 0;
        const total = this.assignments.reduce(
          (sum, a) => sum + (a.post.post_type.difficulty_weight || 1),
          0
        );
        return (total / this.assignments.length).toFixed(1);
      },

      get totalPages() {
        return Math.ceil(this.filteredAssignments.length / this.itemsPerPage);
      },

      get paginatedAssignments() {
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        return this.filteredAssignments.slice(start, end);
      },

      get startRecord() {
        return (this.currentPage - 1) * this.itemsPerPage + 1;
      },

      get endRecord() {
        return Math.min(
          this.currentPage * this.itemsPerPage,
          this.filteredAssignments.length
        );
      },

      get visiblePages() {
        const pages = [];
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(this.totalPages, this.currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
          pages.push(i);
        }

        return pages;
      },
    };
  }
</script>

<!-- New Assignment Modal -->
<div
  x-show="showNewAssignmentModal"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  style="display: none"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3 text-center">
      <h3 class="text-lg font-medium text-gray-900">Create New Assignment</h3>
      <form @submit.prevent="createNewAssignment()" class="mt-4 space-y-4">
        <!-- Personnel Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Personnel</label
          >
          <select
            x-model="newAssignment.person_id"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Select Personnel</option>
            <template x-for="person in personnel" :key="person.id">
              <option
                :value="person.id"
                x-text="`${person.rank} ${person.name}`"
              ></option>
            </template>
          </select>
        </div>

        <!-- Post Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Post</label
          >
          <select
            x-model="newAssignment.post_id"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="">Select Post</option>
            <template x-for="post in posts" :key="post.id">
              <option :value="post.id" x-text="post.name"></option>
            </template>
          </select>
        </div>

        <!-- Duty Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Duty Date</label
          >
          <input
            type="date"
            x-model="newAssignment.duty_date"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <!-- Time Range -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Start Time</label
            >
            <input
              type="time"
              x-model="newAssignment.start_time"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >End Time</label
            >
            <input
              type="time"
              x-model="newAssignment.end_time"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Notes</label
          >
          <textarea
            x-model="newAssignment.notes"
            rows="3"
            placeholder="Optional notes"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
          ></textarea>
        </div>

        <!-- Buttons -->
        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            class="flex-1 military-primary py-2 px-4 rounded-md text-white font-medium hover:opacity-90"
          >
            Create Assignment
          </button>
          <button
            type="button"
            @click="showNewAssignmentModal = false"
            class="flex-1 bg-gray-300 hover:bg-gray-400 py-2 px-4 rounded-md text-gray-700 font-medium"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Assignment Modal -->
<div
  x-show="showEditAssignmentModal"
  x-cloak
  class="fixed inset-0 z-50 overflow-y-auto"
  x-transition:enter="transition-opacity duration-300"
  x-transition:enter-start="opacity-0"
  x-transition:enter-end="opacity-100"
  x-transition:leave="transition-opacity duration-200"
  x-transition:leave-start="opacity-100"
  x-transition:leave-end="opacity-0"
  @click="showEditAssignmentModal = false"
>
  <div class="flex items-center justify-center min-h-screen px-4 py-6">
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6" @click.stop>
      <form @submit.prevent="updateAssignment()">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Edit Assignment</h3>
          <button
            type="button"
            @click="showEditAssignmentModal = false"
            class="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <div class="space-y-4" x-show="editingAssignment">
          <div>
            <label
              for="edit-assignment-person"
              class="block text-sm font-medium text-gray-700"
              >Personnel</label
            >
            <select
              id="edit-assignment-person"
              x-model="editingAssignment.person_id"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              required
            >
              <option value="">Select personnel...</option>
              <template x-for="person in personnel" :key="person.id">
                <option :value="person.id" x-text="person.name"></option>
              </template>
            </select>
          </div>

          <div>
            <label
              for="edit-assignment-post"
              class="block text-sm font-medium text-gray-700"
              >Post</label
            >
            <select
              id="edit-assignment-post"
              x-model="editingAssignment.post_id"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              required
            >
              <option value="">Select post...</option>
              <template x-for="post in posts" :key="post.id">
                <option :value="post.id" x-text="post.name"></option>
              </template>
            </select>
          </div>

          <div>
            <label
              for="edit-assignment-duty-date"
              class="block text-sm font-medium text-gray-700"
              >Duty Date</label
            >
            <input
              type="date"
              id="edit-assignment-duty-date"
              x-model="editingAssignment.duty_date"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label
              for="edit-assignment-start-time"
              class="block text-sm font-medium text-gray-700"
              >Start Time</label
            >
            <input
              type="time"
              id="edit-assignment-start-time"
              x-model="editingAssignment.start_time"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="edit-assignment-end-time"
              class="block text-sm font-medium text-gray-700"
              >End Time</label
            >
            <input
              type="time"
              id="edit-assignment-end-time"
              x-model="editingAssignment.end_time"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div>
            <label
              for="edit-assignment-notes"
              class="block text-sm font-medium text-gray-700"
              >Notes</label
            >
            <textarea
              id="edit-assignment-notes"
              x-model="editingAssignment.notes"
              rows="3"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            ></textarea>
          </div>
        </div>

        <div class="mt-6 flex space-x-3">
          <button
            type="submit"
            class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-md text-white font-medium"
          >
            Update Assignment
          </button>
          <button
            type="button"
            @click="showEditAssignmentModal = false"
            class="flex-1 bg-gray-300 hover:bg-gray-400 py-2 px-4 rounded-md text-gray-700 font-medium"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
