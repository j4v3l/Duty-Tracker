{% extends "base.html" %} {% block title %}Fairness Analytics - Duty Tracker{%
endblock %} {% block head %}
<script>
  // Pass server data to Alpine.js
  window.serverData = {
    stats: {{ stats | tojson | safe }},
    fairness_stats: {{ fairness_stats | tojson | safe }},
    post_distribution_stats: {{ post_distribution_stats | tojson | safe }}
  };
</script>
{% endblock %} {% block content %}
<div x-data="fairnessPageData()" x-init="init()">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-balance-scale mr-2"></i>
          Fairness Analytics
        </h1>
        <p class="text-gray-600">
          Monitor assignment fairness and workload distribution
        </p>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white p-4 rounded-lg shadow flex items-center space-x-6">
        <div class="text-center">
          <div
            class="text-2xl font-bold text-purple-600"
            x-text="formatNumber(stats.fairness_variance || 0, 2)"
          ></div>
          <div class="text-sm text-gray-500">Fairness Variance</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-blue-600"
            x-text="fairnessStats.length"
          ></div>
          <div class="text-sm text-gray-500">Personnel Tracked</div>
        </div>
        <div class="text-center">
          <div
            class="text-2xl font-bold text-green-600"
            x-text="balancedPersonnelCount"
          ></div>
          <div class="text-sm text-gray-500">Well Balanced</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="mb-6 flex flex-wrap gap-4">
    <button
      @click="recalculateFairness()"
      class="military-primary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
      :disabled="recalculating"
    >
      <i class="fas fa-balance-scale mr-2"></i>
      <span x-show="!recalculating">Recalculate Fairness</span>
      <span x-show="recalculating">Calculating...</span>
    </button>

    <button
      @click="generateReport()"
      class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors"
    >
      <i class="fas fa-file-export mr-2"></i>
      Generate Report
    </button>

    <button
      @click="refreshData()"
      class="military-secondary px-6 py-2 rounded-lg font-medium hover:opacity-90 transition-opacity"
    >
      <i class="fas fa-sync mr-2"></i>
      Refresh
    </button>

    <!-- View Toggle -->
    <div class="flex gap-2 ml-auto">
      <button
        @click="viewMode = 'cards'"
        :class="viewMode === 'cards' ? 'military-primary' : 'bg-gray-200 text-gray-700'"
        class="px-4 py-2 rounded-lg font-medium transition-colors"
      >
        <i class="fas fa-th mr-2"></i>
        Cards
      </button>
      <button
        @click="viewMode = 'table'"
        :class="viewMode === 'table' ? 'military-primary' : 'bg-gray-200 text-gray-700'"
        class="px-4 py-2 rounded-lg font-medium transition-colors"
      >
        <i class="fas fa-table mr-2"></i>
        Table
      </button>
    </div>
  </div>

  <!-- Fairness Distribution Chart -->
  <div class="bg-white p-6 rounded-lg shadow mb-8">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
      <i class="fas fa-chart-bar mr-2"></i>
      Fairness Score Distribution
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="text-center">
        <div
          class="text-2xl font-bold text-red-600"
          x-text="getScoreRangeCount(0, 2)"
        ></div>
        <div class="text-sm text-gray-500">Critical (0-2)</div>
        <div class="w-full bg-red-200 rounded-full h-2 mt-2">
          <div
            class="bg-red-600 h-2 rounded-full"
            :style="`width: ${getScoreRangePercentage(0, 2)}%`"
          ></div>
        </div>
      </div>
      <div class="text-center">
        <div
          class="text-2xl font-bold text-orange-600"
          x-text="getScoreRangeCount(2, 4)"
        ></div>
        <div class="text-sm text-gray-500">Poor (2-4)</div>
        <div class="w-full bg-orange-200 rounded-full h-2 mt-2">
          <div
            class="bg-orange-600 h-2 rounded-full"
            :style="`width: ${getScoreRangePercentage(2, 4)}%`"
          ></div>
        </div>
      </div>
      <div class="text-center">
        <div
          class="text-2xl font-bold text-yellow-600"
          x-text="getScoreRangeCount(4, 6)"
        ></div>
        <div class="text-sm text-gray-500">Fair (4-6)</div>
        <div class="w-full bg-yellow-200 rounded-full h-2 mt-2">
          <div
            class="bg-yellow-600 h-2 rounded-full"
            :style="`width: ${getScoreRangePercentage(4, 6)}%`"
          ></div>
        </div>
      </div>
      <div class="text-center">
        <div
          class="text-2xl font-bold text-green-600"
          x-text="getScoreRangeCount(6, 8)"
        ></div>
        <div class="text-sm text-gray-500">Good (6-8)</div>
        <div class="w-full bg-green-200 rounded-full h-2 mt-2">
          <div
            class="bg-green-600 h-2 rounded-full"
            :style="`width: ${getScoreRangePercentage(6, 8)}%`"
          ></div>
        </div>
      </div>
      <div class="text-center">
        <div
          class="text-2xl font-bold text-blue-600"
          x-text="getScoreRangeCount(8, 10)"
        ></div>
        <div class="text-sm text-gray-500">Excellent (8+)</div>
        <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
          <div
            class="bg-blue-600 h-2 rounded-full"
            :style="`width: ${getScoreRangePercentage(8, 10)}%`"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Personnel Cards View -->
  <div
    x-show="viewMode === 'cards'"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"
  >
    <template x-for="stat in sortedFairnessStats" :key="stat.person_id">
      <div
        :class="getFairnessCardClass(stat.fairness_score)"
        class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow border-l-4"
      >
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3
                class="text-lg font-semibold text-gray-900 cursor-pointer hover:text-blue-600"
                @click="openPersonnelModal(stat.person_id)"
                x-text="stat.person_name"
              ></h3>
              <div class="text-sm text-gray-500">
                <span x-text="stat.total_assignments"></span> assignments â€¢
                <span x-text="stat.total_difficulty_points"></span> points
              </div>
            </div>
            <div class="text-right">
              <div
                :class="getFairnessScoreClass(stat.fairness_score)"
                class="text-2xl font-bold"
                x-text="formatNumber(stat.fairness_score, 1)"
              ></div>
              <div class="text-xs text-gray-500">Fairness Score</div>
            </div>
          </div>

          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Last Assignment:</span>
              <span
                class="font-medium"
                x-text="stat.last_assignment_date ? formatDate(stat.last_assignment_date) : 'None'"
              ></span>
            </div>
            <div
              x-show="stat.consecutive_standby > 0"
              class="flex justify-between text-sm"
            >
              <span class="text-gray-600">Consecutive Standby:</span>
              <span
                class="font-medium text-yellow-600"
                x-text="stat.consecutive_standby"
              ></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Avg Difficulty:</span>
              <span
                class="font-medium"
                x-text="formatNumber(stat.total_difficulty_points / Math.max(stat.total_assignments, 1), 1)"
              ></span>
            </div>
          </div>

          <!-- Fairness Progress Bar -->
          <div class="mt-4">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
              <span>Workload Balance</span>
              <span x-text="getFairnessLabel(stat.fairness_score)"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div
                :class="getFairnessBarClass(stat.fairness_score)"
                class="h-2 rounded-full transition-all duration-300"
                :style="`width: ${Math.min((stat.fairness_score / 10) * 100, 100)}%`"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Personnel Table View -->
  <div
    x-show="viewMode === 'table'"
    class="bg-white shadow overflow-hidden sm:rounded-md mb-8"
  >
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900">
        Fairness Statistics Table
      </h3>
    </div>

    <div class="overflow-x-auto">
      <table class="responsive-table min-w-full">
        <thead>
          <tr>
            <th>Personnel</th>
            <th>Fairness Score</th>
            <th>Assignments</th>
            <th>Difficulty Points</th>
            <th>Avg Difficulty</th>
            <th>Last Assignment</th>
            <th>Consecutive Standby</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="stat in sortedFairnessStats" :key="stat.person_id">
            <tr
              :class="getFairnessRowClass(stat.fairness_score)"
              class="hover:bg-gray-50"
            >
              <td>
                <span
                  class="font-medium cursor-pointer text-blue-600 hover:text-blue-800"
                  @click="openPersonnelModal(stat.person_id)"
                  x-text="stat.person_name"
                ></span>
              </td>
              <td>
                <div class="flex items-center">
                  <span
                    :class="getFairnessScoreClass(stat.fairness_score)"
                    class="text-lg font-bold mr-2"
                    x-text="formatNumber(stat.fairness_score, 1)"
                  ></span>
                  <span
                    :class="getFairnessLabelClass(stat.fairness_score)"
                    class="px-2 py-1 text-xs font-medium rounded-full"
                    x-text="getFairnessLabel(stat.fairness_score)"
                  ></span>
                </div>
              </td>
              <td class="text-center">
                <span
                  class="text-lg font-semibold"
                  x-text="stat.total_assignments"
                ></span>
              </td>
              <td class="text-center">
                <span
                  class="text-lg font-semibold"
                  x-text="stat.total_difficulty_points"
                ></span>
              </td>
              <td class="text-center">
                <span
                  x-text="formatNumber(stat.total_difficulty_points / Math.max(stat.total_assignments, 1), 1)"
                ></span>
              </td>
              <td>
                <span
                  x-text="stat.last_assignment_date ? formatDate(stat.last_assignment_date) : 'None'"
                ></span>
              </td>
              <td class="text-center">
                <span
                  :class="stat.consecutive_standby > 0 ? 'text-yellow-600 font-medium' : 'text-gray-500'"
                  x-text="stat.consecutive_standby || 'â€”'"
                ></span>
              </td>
              <td>
                <button
                  @click="openPersonnelModal(stat.person_id)"
                  class="text-blue-600 hover:text-blue-800 text-sm"
                >
                  <i class="fas fa-eye mr-1"></i>
                  Details
                </button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-calculator text-3xl text-blue-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Avg Fairness</h3>
          <p
            class="text-2xl font-bold text-blue-600"
            x-text="formatNumber(averageFairness, 2)"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-chart-line text-3xl text-green-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Best Balanced</h3>
          <p
            class="text-lg font-bold text-green-600"
            x-text="bestBalancedPerson"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i
          class="fas fa-exclamation-triangle text-3xl text-yellow-500 mr-4"
        ></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Needs Attention</h3>
          <p
            class="text-2xl font-bold text-yellow-600"
            x-text="needsAttentionCount"
          ></p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex items-center">
        <i class="fas fa-clock text-3xl text-purple-500 mr-4"></i>
        <div>
          <h3 class="text-lg font-medium text-gray-900">Standby Personnel</h3>
          <p
            class="text-2xl font-bold text-purple-600"
            x-text="standbyPersonnelCount"
          ></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Personnel Details Modal -->
  <div
    x-show="showPersonnelModal"
    x-cloak
    class="fixed inset-0 z-50 overflow-y-auto"
    x-transition:enter="transition-opacity duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="showPersonnelModal = false"
  >
    <div class="flex items-center justify-center min-h-screen px-4 py-6">
      <div
        class="bg-white rounded-lg shadow-lg max-w-md w-full p-6"
        @click.stop
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Personnel Details</h3>
          <button
            @click="showPersonnelModal = false"
            class="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <template x-if="personnelDetails">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Name</label
              >
              <p
                class="mt-1 text-sm text-gray-900"
                x-text="personnelDetails.name"
              ></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Rank</label
              >
              <p
                class="mt-1 text-sm text-gray-900"
                x-text="personnelDetails.rank"
              ></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Position</label
              >
              <p
                class="mt-1 text-sm text-gray-900"
                x-text="personnelDetails.position"
              ></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Active</label
              >
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                :class="personnelDetails.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                x-text="personnelDetails.is_active ? 'Yes' : 'No'"
              ></span>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Contact</label
              >
              <p
                class="mt-1 text-sm text-gray-900"
                x-text="personnelDetails.contact_info || 'N/A'"
              ></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Notes</label
              >
              <p
                class="mt-1 text-sm text-gray-900"
                x-text="personnelDetails.notes || 'N/A'"
              ></p>
            </div>
          </div>
        </template>

        <div class="mt-6 flex justify-end">
          <button
            @click="showPersonnelModal = false"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function fairnessPageData() {
    return {
      loading: false,
      recalculating: false,
      fairnessStats: [],
      stats: {},
      viewMode: "cards",
      showPersonnelModal: false,
      personnelDetails: null,

      init() {
        this.stats = window.serverData.stats || {};
        this.fairnessStats = window.serverData.fairness_stats || [];
      },

      refreshData() {
        window.location.reload();
      },

      recalculateFairness() {
        this.recalculating = true;
        // Mock API call - replace with actual implementation
        setTimeout(() => {
          this.recalculating = false;
          this.refreshData();
        }, 2000);
      },

      generateReport() {
        // Create CSV report
        const csvContent = this.generateCSVReport();
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `fairness-report-${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      generateCSVReport() {
        const headers = [
          "Personnel Name",
          "Fairness Score",
          "Total Assignments",
          "Total Difficulty Points",
          "Average Difficulty",
          "Last Assignment Date",
          "Consecutive Standby",
          "Status",
        ];

        let csvContent = headers.join(",") + "\n";

        this.sortedFairnessStats.forEach((stat) => {
          const row = [
            stat.person_name,
            stat.fairness_score.toFixed(2),
            stat.total_assignments,
            stat.total_difficulty_points,
            (
              stat.total_difficulty_points / Math.max(stat.total_assignments, 1)
            ).toFixed(1),
            stat.last_assignment_date
              ? this.formatDate(stat.last_assignment_date)
              : "None",
            stat.consecutive_standby || 0,
            this.getFairnessLabel(stat.fairness_score),
          ];
          csvContent += row.map((field) => `"${field}"`).join(",") + "\n";
        });

        return csvContent;
      },

      openPersonnelModal(personId) {
        fetch(`/api/personnel/${personId}/details`)
          .then((response) => response.json())
          .then((data) => {
            this.personnelDetails = data;
            this.showPersonnelModal = true;
          })
          .catch((error) =>
            console.error("Error fetching personnel details:", error)
          );
      },

      formatNumber(num, decimals = 0) {
        if (num === null || num === undefined) return "0";
        return Number(num).toFixed(decimals);
      },

      formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString();
      },

      getFairnessScoreClass(score) {
        if (score < 2) return "text-red-600";
        if (score < 4) return "text-orange-600";
        if (score < 6) return "text-yellow-600";
        if (score < 8) return "text-green-600";
        return "text-blue-600";
      },

      getFairnessCardClass(score) {
        if (score < 2) return "border-red-500";
        if (score < 4) return "border-orange-500";
        if (score < 6) return "border-yellow-500";
        if (score < 8) return "border-green-500";
        return "border-blue-500";
      },

      getFairnessRowClass(score) {
        if (score < 4) return "bg-red-50";
        if (score < 6) return "bg-yellow-50";
        return "";
      },

      getFairnessLabel(score) {
        if (score < 2) return "Critical";
        if (score < 4) return "Poor";
        if (score < 6) return "Fair";
        if (score < 8) return "Good";
        return "Excellent";
      },

      getFairnessLabelClass(score) {
        if (score < 2) return "bg-red-100 text-red-800";
        if (score < 4) return "bg-orange-100 text-orange-800";
        if (score < 6) return "bg-yellow-100 text-yellow-800";
        if (score < 8) return "bg-green-100 text-green-800";
        return "bg-blue-100 text-blue-800";
      },

      getFairnessBarClass(score) {
        if (score < 2) return "bg-red-500";
        if (score < 4) return "bg-orange-500";
        if (score < 6) return "bg-yellow-500";
        if (score < 8) return "bg-green-500";
        return "bg-blue-500";
      },

      getScoreRangeCount(min, max) {
        return this.fairnessStats.filter(
          (stat) => stat.fairness_score >= min && stat.fairness_score < max
        ).length;
      },

      getScoreRangePercentage(min, max) {
        if (this.fairnessStats.length === 0) return 0;
        const count = this.getScoreRangeCount(min, max);
        return (count / this.fairnessStats.length) * 100;
      },

      get sortedFairnessStats() {
        return [...this.fairnessStats].sort(
          (a, b) => a.fairness_score - b.fairness_score
        );
      },

      get balancedPersonnelCount() {
        return this.fairnessStats.filter((stat) => stat.fairness_score >= 6)
          .length;
      },

      get averageFairness() {
        if (this.fairnessStats.length === 0) return 0;
        const total = this.fairnessStats.reduce(
          (sum, stat) => sum + stat.fairness_score,
          0
        );
        return total / this.fairnessStats.length;
      },

      get bestBalancedPerson() {
        if (this.fairnessStats.length === 0) return "N/A";
        const best = this.fairnessStats.reduce((best, stat) =>
          stat.fairness_score > best.fairness_score ? stat : best
        );
        return best.person_name;
      },

      get needsAttentionCount() {
        return this.fairnessStats.filter((stat) => stat.fairness_score < 4)
          .length;
      },

      get standbyPersonnelCount() {
        return this.fairnessStats.filter((stat) => stat.consecutive_standby > 0)
          .length;
      },
    };
  }
</script>
{% endblock %}
